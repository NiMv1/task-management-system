server:
  port: 8080

spring:
  application:
    name: api-gateway
  
  cloud:
    gateway:
      routes:
        # Auth Service
        - id: auth-service
          uri: ${AUTH_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/v1/auth/**
          filters:
            - name: CircuitBreaker
              args:
                name: authCircuitBreaker
                fallbackUri: forward:/fallback/auth
        
        # Task Service - Tasks
        - id: task-service-tasks
          uri: ${TASK_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/v1/tasks/**
          filters:
            - name: CircuitBreaker
              args:
                name: taskCircuitBreaker
                fallbackUri: forward:/fallback/task
        
        # Task Service - Projects
        - id: task-service-projects
          uri: ${TASK_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/v1/projects/**
          filters:
            - name: CircuitBreaker
              args:
                name: taskCircuitBreaker
                fallbackUri: forward:/fallback/task
      
      default-filters:
        - name: RequestRateLimiter
          args:
            redis-rate-limiter.replenishRate: 100
            redis-rate-limiter.burstCapacity: 200
        - AddRequestHeader=X-Gateway-Request-Id, ${random.uuid}

# Actuator
management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus,metrics,gateway
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true
  metrics:
    tags:
      application: ${spring.application.name}

# Логирование
logging:
  level:
    root: INFO
    org.springframework.cloud.gateway: DEBUG
    com.taskmanager: DEBUG

# Resilience4j
resilience4j:
  circuitbreaker:
    instances:
      authCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 5s
        failureRateThreshold: 50
      taskCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 5s
        failureRateThreshold: 50
  timelimiter:
    instances:
      authCircuitBreaker:
        timeoutDuration: 3s
      taskCircuitBreaker:
        timeoutDuration: 3s
